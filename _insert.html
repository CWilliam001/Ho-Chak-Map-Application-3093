<template id="insert">
    <div>
        <h1 class="mt-5">Insert Restaurant</h1>
        
        <form class="form" @submit.prevent="submit">
            <div class="mt-3">
                <label for="userName" class="form-label">Recommender Name</label>
                <input v-model.trim="userName" required maxlength="60" type="text" class="form-control" id="userName" v-focus ref="userName">
            </div>
            <div class="mt-3">
                <label for="restaurantName" class="form-label">Restaurant Name</label>
                <input v-model.trim="restaurantName" required maxlength="60" type="text" class="form-control" id="restaurantName">
            </div>
            <div class="mt-3">
                <div class="row">
                    <div class="col">
                        <div>    
                            <label for="location" class="form-label">Location</label>
                            <input v-model.trim="location" required maxlength="150" type="text" class="form-control" id="location">
                        </div>
                        <div></div>
                        <div></div>
                    </div>
                    <div class="col">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <label for="phone" class="form-label">Phone Number</label>
                <input v-model.trim="phone" required maxlength="150" type="text" class="form-control" id="phone" title="Format: 01X-XXXXXXXX" pattern="01\d-\d{7,8}" @input="validatePhone">
            </div>
            <div class="mt-3">
                <div class="row">
                    <div class="col">
                        <label for="photo" class="form-label">Image</label>
                        <input class="form-control" id="photo" @change="change" type="file" required accept="image/*" ref="file" style="background-color: #fff;">
                    </div>
                    <div class="col">
                        <label></label>
                        <img :src="photo || temp" class="photo">
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <label for="desc" class="form-label">Description</label>
                <textarea v-model.trim="desc" class="form-control" id="desc" rows="5" required></textarea>
            </div>
            <div class="mt-4">
                <button class="btn btn-info text-light me-2">Insert</button>
                <button @click.prevent="reset" class="btn btn-warning text-light me-2">Reset</button>
                <button @click.prevent="$router.push('/home')" class="btn btn-danger text-light">Cancel</button>
            </div>
        </form>
    </div>
</template>

<script>
    Vue.component('insert', {
        template: '#insert',
        data: () => ({
            restaurantName   : '',
            location : '',
            phone: '',
            photo : '',
            desc: '',
            temp : 'image/photo.png',
            lat: 0,
            lng: 0
        }),
        props: {
                userName: String ,
        },
        methods: {
            change(e) {
                let f = e.target.files[0];
                crop(f, 280, 200, 'dataURL', 'image/webp').then(dataURL => this.photo = dataURL).catch(err => this.photo = '');
            },
            validateRestaurantName(e) {
                let el = e.target;
                let restaurantName = el.value;

                el.setCustomValidity('');
                if (el.validity.valid) {
                    let r = this.$root.restaurants.find(r => r.restaurantName == restaurantName);
                    if (r) {
                        el.setCustomValidity('Duplicate Restaurant Name');
                    }
                }
            },
            validatePhone(e) {
                let el = e.target;
                let phone = el.value;

                el.setCustomValidity('');
                if (el.validity.valid) {
                    let f = this.$root.restaurants.find(f => f.phone == phone);
                    if (f) {
                        el.setCustomValidity('Duplicate Phone');
                    }
                }
            },
            reset() {
                this.restaurantName = '';
                this.location = '';
                this.phone = '';
                this.desc = '';
                this.photo = '';
                this.$refs.file.value = '';
                this.$refs.userName.focus();
            },
            submit() {
                ref.doc().set({
                    userName: this.userName,
                    restaurantName: this.restaurantName,
                    location: this.location,
                    phone: this.phone,
                    photo: this.photo,
                    desc: this.desc
                });
                this.$router.push('home');
            }
        },
        created() {
            document.title = 'Ho Chak : Insert Restaurant';
        }
    });

    const gm = google.maps;
    const center = { lat: 3.214957, lng: 101.728436 };

    const map = new gm.Map($('#map')[0], {
        center,
        zoom: 16,
        disableDefaultUI: true,
        clickableIcons: false,
        // TODO(1): Disable double click zoom
        disableDoubleClickZoom: true
    });
</script>